(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{339:function(n,t,a){"use strict";a.r(t);var s=a(13),e=Object(s.a)({},(function(){var n=this,t=n._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[t("h1",{attrs:{id:"springäº‹åŠ¡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#springäº‹åŠ¡"}},[n._v("#")]),n._v(" Springäº‹åŠ¡")]),n._v(" "),t("p",[n._v("ä¸€ã€æœªå¼€å¯äº‹åŠ¡æ‰§è¡Œæµç¨‹\n1.æ¯ä¸ªMapperæ¥å£çš„æ‰§è¡Œæ—¶ï¼ˆmapperç±»çš„æ–¹æ³•ï¼‰ï¼Œè°ƒç”¨Mapperè‡ªå¸¦çš„sqlsessionTemplateå»æ‰§è¡Œï¼ŒsqlsessionTemplateè°ƒç”¨è‡ªèº«çš„\nSqlSession sqlSessionProxyï¼ˆæ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†çš„ç±»ï¼‰å»æ‰§è¡Œï¼Œæ‰€ä»¥æœ€ç»ˆè°ƒç”¨SqlSessionInterceptorçš„invokeæ–¹æ³•ï¼Œå…ˆé€šè¿‡getSqlSessionè·å–sqlsessionï¼Œå…ˆä»çº¿ç¨‹threadlocalä¸­è·å–ï¼Œè·å–ä¸åˆ°è¿›å…¥sessionFactory.openSessionè·å–ï¼Œè·å–åˆ°çš„sqlsessioné‡Œé¢æœ‰ä¸ªexcutoræ‰§è¡Œå™¨ï¼Œé‡Œé¢æœ‰ä¸ªtransactionäº‹åŠ¡ï¼Œäº‹åŠ¡é‡Œé¢çš„connectionæ•°æ®åº“è¿æ¥æ˜¯ç©ºçš„SpringManagedTransactionã€‚excutoræ‰§è¡Œçš„æ—¶å€™ä¼šå»è·å–è¿æ¥SpringManagedTransaction.getConnection()ï¼š")]),n._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[n._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Connection")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getConnection")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("throws")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SQLException")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("connection "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("==")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("openConnection")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("return")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("connection"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("/**\n   * Gets a connection from Spring transaction manager and discovers if this {@code Transaction} should manage\n   * connection or let it to Spring.\n   * <p>\n   * It also reads autocommit setting because when using Spring Transaction MyBatis thinks that autocommit is always\n   * false and will always call commit/rollback so we need to no-op that calls.\n   */")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("private")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("void")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("openConnection")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("throws")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SQLException")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("connection "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("DataSourceUtils")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getConnection")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("dataSource"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("autoCommit "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("connection"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getAutoCommit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("isConnectionTransactional "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("DataSourceUtils")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("isConnectionTransactional")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("connection"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("dataSource"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n    LOGGER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("->")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"JDBC Connection ["')]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("+")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("connection "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("+")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"] will"')]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("+")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("isConnectionTransactional "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("?")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('" "')]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v(":")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('" not "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("+")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"be managed by Spring"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])])]),t("p",[n._v("äº‹åŠ¡è·å–è¿æ¥çš„æ—¶å€™ä¹Ÿæ˜¯æ ¹æ®æ•°æ®æºä»threadlocalè·å–ï¼Œä¸è¿‡è·å–ä¸åˆ°ï¼Œç„¶åç”¨æ•°æ®æºæ–°å»ºä¸€ä¸ªè¿æ¥è¿”å›ã€‚")]),n._v(" "),t("p",[n._v("æ¯ä¸ªMapperéƒ½æ˜¯ä¸Šé¢çš„æ‰§è¡Œæµç¨‹")]),n._v(" "),t("p",[n._v("äºŒã€å¼€å¯äº‹åŠ¡:")]),n._v(" "),t("p",[n._v("1.@Transactional   çš„æ‹¦æˆªå™¨ TransactionIntercepter")]),n._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[n._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("//å¼€å¯äº‹åŠ¡ï¼ˆæ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼Œè·å–ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œä¿å­˜åˆ°threadlocalï¼Œäº‹åŠ¡æŒæœ‰è¿™ä¸ªè¿æ¥ï¼Œäº‹åŠ¡ä¹Ÿä¿å­˜åœ¨threadlocalï¼‰\t\t")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("TransactionInfo")]),n._v(" txInfo "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("createTransactionIfNecessary")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("ptm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" txAttr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" joinpointIdentification"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Object")]),n._v(" retVal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("try")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("// This is an around advice: Invoke the next interceptor in the chain.")]),n._v("\n\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("// This will normally result in a target object being invoked.")]),n._v("\n\t\t\t\tretVal "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" invocation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("proceedWithInvocation")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("catch")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Throwable")]),n._v(" ex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("// target invocation exception")]),n._v("\n\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("completeTransactionAfterThrowing")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("txInfo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" ex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("throw")]),n._v(" ex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("finally")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("cleanupTransactionInfo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("txInfo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])])]),t("p",[n._v("ç¬¬ä¸€ä¸ªMapperæ¥å£çš„æ‰§è¡Œæ—¶ï¼ˆmapperç±»çš„æ–¹æ³•ï¼‰ï¼Œè·Ÿä¸Šé¢ä¸€æ ·ï¼Œåªæ˜¯äº‹åŠ¡è·å–è¿æ¥DataSourceUtils.getConnectionçš„æ—¶å€™ä¹Ÿæ˜¯æ ¹æ®æ•°æ®æºä»threadlocalè·å–ï¼Œä¸è¿‡è¿™æ¬¡èƒ½å–åˆ°äº†ã€‚ç»‘å®šåˆ°å½“å‰äº‹åŠ¡ä¸­ï¼Œå½“å‰äº‹åŠ¡ç»‘å®šåœ¨sqlsessionä¸­ï¼Œsqlsessionåˆå­˜åˆ°threadlocalä¸­ã€‚")]),n._v(" "),t("p",[n._v("ä¸‹ä¸€ä¸ªMapperæ¥å£çš„æ‰§è¡Œæ—¶ï¼ŒgetSqlSessionè·å–sqlsessionï¼Œå…ˆä»çº¿ç¨‹threadlocalä¸­è·å–ï¼Œè¿™æ¬¡èƒ½è·å–åˆ°å‰ä¸€ä¸ªå­˜ä¸‹æ¥çš„sqlsessionï¼Œäº‹åŠ¡ä¸è¿æ¥éƒ½æ˜¯åŒä¸€ä¸ªã€‚")]),n._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("private")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionInterceptor")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("implements")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("InvocationHandler")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Override")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Object")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("invoke")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Object")]),n._v(" proxy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Method")]),n._v(" method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Object")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),n._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("throws")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Throwable")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSession")]),n._v(" sqlSession "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getSqlSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("sqlSessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("executorType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("exceptionTranslator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("try")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Object")]),n._v(" result "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("invoke")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("sqlSession"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("isSqlSessionTransactional")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("sqlSession"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("sqlSessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("// force commit even on non-dirty sessions because some databases require")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("// a commit/rollback before calling close()")]),n._v("\n          sqlSession"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("commit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[n._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("return")]),n._v(" result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("catch")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Throwable")]),n._v(" t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Throwable")]),n._v(" unwrapped "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("unwrapThrowable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("exceptionTranslator "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("!=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("null")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("&&")]),n._v(" unwrapped "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("instanceof")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("PersistenceException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("// release the connection to avoid a deadlock if the translator is no loaded. See issue #22")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("closeSqlSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("sqlSession"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("sqlSessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n          sqlSession "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Throwable")]),n._v(" translated "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("exceptionTranslator\n              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("translateExceptionIfPossible")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("PersistenceException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" unwrapped"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("translated "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("!=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n            unwrapped "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" translated"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("throw")]),n._v(" unwrapped"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("finally")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("sqlSession "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("!=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n          "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("closeSqlSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("sqlSession"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("sqlSessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("static")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSession")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getSqlSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionFactory")]),n._v(" sessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ExecutorType")]),n._v(" executorType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("PersistenceExceptionTranslator")]),n._v(" exceptionTranslator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("notNull")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("sessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" NO_SQL_SESSION_FACTORY_SPECIFIED"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("notNull")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("executorType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" NO_EXECUTOR_TYPE_SPECIFIED"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionHolder")]),n._v(" holder "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSessionHolder")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("TransactionSynchronizationManager")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getResource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("sessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSession")]),n._v(" session "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("sessionHolder")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("executorType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" holder"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("session "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("!=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("return")]),n._v(" session"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\n    LOGGER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("->")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"Creating a new SqlSession"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    session "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" sessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("openSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("executorType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("registerSessionHolder")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("sessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" executorType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" exceptionTranslator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" session"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("return")]),n._v(" session"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("private")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SqlSession")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("openSessionFromDataSource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ExecutorType")]),n._v(" execType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("TransactionIsolationLevel")]),n._v(" level"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("boolean")]),n._v(" autoCommit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Transaction")]),n._v(" tx "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("try")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("final")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Environment")]),n._v(" environment "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" configuration"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getEnvironment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("final")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("TransactionFactory")]),n._v(" transactionFactory "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getTransactionFactoryFromEnvironment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("environment"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n      tx "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" transactionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("newTransaction")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("environment"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("getDataSource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" level"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" autoCommit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("final")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Executor")]),n._v(" executor "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" configuration"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("newExecutor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("tx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" execType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("return")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("new")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("DefaultSqlSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("configuration"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" executor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" autoCommit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("catch")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Exception")]),n._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("closeTransaction")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("tx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("// may have fetched a connection so lets call close()")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("throw")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ExceptionFactory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("wrapException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"Error opening session.  Cause: "')]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("+")]),n._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("finally")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ErrorContext")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("reset")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])])]),t("h1",{attrs:{id:""}},[t("a",{staticClass:"header-anchor",attrs:{href:"#"}},[n._v("#")])]),n._v(" "),t("h3",{attrs:{id:"mybaits-æºç è§£æ-åäºŒ-mybatisçš„äº‹åŠ¡å¦‚ä½•è¢«springç®¡ç†-mybatiså’Œspringäº‹åŠ¡ä¸­ç”¨çš„connectionæ˜¯åŒä¸€ä¸ªå—"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mybaits-æºç è§£æ-åäºŒ-mybatisçš„äº‹åŠ¡å¦‚ä½•è¢«springç®¡ç†-mybatiså’Œspringäº‹åŠ¡ä¸­ç”¨çš„connectionæ˜¯åŒä¸€ä¸ªå—"}},[n._v("#")]),n._v(" "),t("a",{attrs:{href:"https://www.cnblogs.com/java-chen-hao/p/11839993.html",target:"_blank",rel:"noopener noreferrer"}},[n._v("Mybaits æºç è§£æ ï¼ˆåäºŒï¼‰----- Mybatisçš„äº‹åŠ¡å¦‚ä½•è¢«Springç®¡ç†ï¼ŸMybatiså’ŒSpringäº‹åŠ¡ä¸­ç”¨çš„Connectionæ˜¯åŒä¸€ä¸ªå—ï¼Ÿ"),t("OutboundLink")],1)]),n._v(" "),t("p",[t("strong",[n._v("ç›®å½•")])]),n._v(" "),t("ul",[t("li",[n._v("SpringManagedTransaction\n"),t("ul",[t("li",[t("a",{attrs:{href:"https://www.cnblogs.com/java-chen-hao/p/11839993.html#_label0_0",target:"_blank",rel:"noopener noreferrer"}},[n._v("org.springframework.jdbc.datasource.DataSourceUtils#getConnection"),t("OutboundLink")],1)]),n._v(" "),t("li",[t("a",{attrs:{href:"https://www.cnblogs.com/java-chen-hao/p/11839993.html#_label0_1",target:"_blank",rel:"noopener noreferrer"}},[n._v("org.springframework.transaction.support.TransactionSynchronizationManager#getResource"),t("OutboundLink")],1)])])])]),n._v(" "),t("p",[t("strong",[n._v("æ­£æ–‡")])]),n._v(" "),t("p",[n._v("ä¸çŸ¥é“ä¸€äº›åŒå­¦æœ‰æ²¡æœ‰è¿™ç§ç–‘é—®ï¼Œä¸ºä»€ä¹ˆMybtisä¸­è¦é…ç½®dataSourceï¼ŒSpringçš„äº‹åŠ¡ä¸­ä¹Ÿè¦é…ç½®dataSourceï¼Ÿé‚£ä¹ˆMybatiså’ŒSpringäº‹åŠ¡ä¸­ç”¨çš„Connectionæ˜¯åŒä¸€ä¸ªå—ï¼Ÿæˆ‘ä»¬å¸¸ç”¨é…ç½®å¦‚ä¸‹")]),n._v(" "),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('\x3c!--ä¼šè¯å·¥å‚ --\x3e\n<bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">\n  <property name="dataSource" ref="dataSource" />\n</bean>\n\n\x3c!--springäº‹åŠ¡ç®¡ç† --\x3e\n<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">\n  <property name="dataSource" ref="dataSource" />\n</bean>\n\n\x3c!--ä½¿ç”¨æ³¨é‡Šäº‹åŠ¡ --\x3e\n<tx:annotation-driven  transaction-manager="transactionManager" />\n')])])]),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("p",[n._v("çœ‹åˆ°æ²¡ï¼Œ"),t("strong",[n._v("sqlSessionFactoryä¸­é…ç½®äº†"),t("strong",[t("strong",[n._v("dataSourceï¼Œ"),t("strong",[t("strong",[n._v("transactionManagerä¹Ÿé…ç½®äº†")])]),n._v("dataSourceï¼Œæˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹")])]),n._v("SqlSessionFactoryBeanè¿™ä¸ªç±»")])]),n._v(" "),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v(' 1 protected SqlSessionFactory buildSqlSessionFactory() throws IOException {\n 2 \n 3     // é…ç½®ç±»\n 4    Configuration configuration;\n 5     // è§£æmybatis-Config.xmlæ–‡ä»¶ï¼Œ\n 6     // å°†ç›¸å…³é…ç½®ä¿¡æ¯ä¿å­˜åˆ°configuration\n 7    XMLConfigBuilder xmlConfigBuilder = null;\n 8    if (this.configuration != null) {\n 9      configuration = this.configuration;\n10      if (configuration.getVariables() == null) {\n11        configuration.setVariables(this.configurationProperties);\n12      } else if (this.configurationProperties != null) {\n13        configuration.getVariables().putAll(this.configurationProperties);\n14      }\n15     //èµ„æºæ–‡ä»¶ä¸ä¸ºç©º\n16    } else if (this.configLocation != null) {\n17      //æ ¹æ®configLocationåˆ›å»ºxmlConfigBuilderï¼ŒXMLConfigBuilderæ„é€ å™¨ä¸­ä¼šåˆ›å»ºConfigurationå¯¹è±¡\n18      xmlConfigBuilder = new XMLConfigBuilder(this.configLocation.getInputStream(), null, this.configurationProperties);\n19      //å°†XMLConfigBuilderæ„é€ å™¨ä¸­åˆ›å»ºçš„Configurationå¯¹è±¡ç›´æ¥èµ‹å€¼ç»™configurationå±æ€§\n20      configuration = xmlConfigBuilder.getConfiguration();\n21    } \n22    \n23     //ç•¥....\n24 \n25    if (xmlConfigBuilder != null) {\n26      try {\n27        //è§£æmybatis-Config.xmlæ–‡ä»¶ï¼Œå¹¶å°†ç›¸å…³é…ç½®ä¿¡æ¯ä¿å­˜åˆ°configuration\n28        xmlConfigBuilder.parse();\n29        if (LOGGER.isDebugEnabled()) {\n30          LOGGER.debug("Parsed configuration file: \'" + this.configLocation + "\'");\n31        }\n32      } catch (Exception ex) {\n33        throw new NestedIOException("Failed to parse config resource: " + this.configLocation, ex);\n34      }\n35    }\n36     \n37    if (this.transactionFactory == null) {\n38      //äº‹åŠ¡é»˜è®¤é‡‡ç”¨SpringManagedTransactionï¼Œè¿™ä¸€å—éå¸¸é‡è¦\n39      this.transactionFactory = new SpringManagedTransactionFactory();\n40    }\n41     // ä¸ºsqlSessionFactoryç»‘å®šäº‹åŠ¡ç®¡ç†å™¨å’Œæ•°æ®æº\n42     // è¿™æ ·sqlSessionFactoryåœ¨åˆ›å»ºsqlSessionçš„æ—¶å€™å¯ä»¥é€šè¿‡è¯¥äº‹åŠ¡ç®¡ç†å™¨è·å–jdbcè¿æ¥ï¼Œä»è€Œæ‰§è¡ŒSQL\n43    configuration.setEnvironment(new Environment(this.environment, this.transactionFactory, this.dataSource));\n44     // è§£æmapper.xml\n45    if (!isEmpty(this.mapperLocations)) {\n46      for (Resource mapperLocation : this.mapperLocations) {\n47        if (mapperLocation == null) {\n48          continue;\n49        }\n50        try {\n51          // è§£æmapper.xmlæ–‡ä»¶ï¼Œå¹¶æ³¨å†Œåˆ°configurationå¯¹è±¡çš„mapperRegistry\n52          XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(mapperLocation.getInputStream(),\n53              configuration, mapperLocation.toString(), configuration.getSqlFragments());\n54          xmlMapperBuilder.parse();\n55        } catch (Exception e) {\n56          throw new NestedIOException("Failed to parse mapping resource: \'" + mapperLocation + "\'", e);\n57        } finally {\n58          ErrorContext.instance().reset();\n59        }\n60 \n61        if (LOGGER.isDebugEnabled()) {\n62          LOGGER.debug("Parsed mapper file: \'" + mapperLocation + "\'");\n63        }\n64      }\n65    } else {\n66      if (LOGGER.isDebugEnabled()) {\n67        LOGGER.debug("Property \'mapperLocations\' was not specified or no matching resources found");\n68      }\n69    }\n70 \n71     // å°†Configurationå¯¹è±¡å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œ\n72     // è°ƒç”¨sqlSessionFactoryBuilderåˆ›å»ºsqlSessionFactoryå¯¹è±¡å®ä¾‹\n73    return this.sqlSessionFactoryBuilder.build(configuration);\n74 }\n')])])]),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("p",[n._v("æˆ‘ä»¬çœ‹ç¬¬39è¡Œï¼ŒMybatisé›†æˆSpringåï¼Œé»˜è®¤ä½¿ç”¨çš„transactionFactoryæ˜¯SpringManagedTransactionFactoryï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹çœ‹å…¶è·å–Transactionçš„æ–¹æ³•")]),n._v(" "),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('private SqlSession openSessionFromConnection(ExecutorType execType, Connection connection) {\n    try {\n      boolean autoCommit;\n      try {\n        autoCommit = connection.getAutoCommit();\n      } catch (SQLException e) {\n        // Failover to true, as most poor drivers\n        // or databases won\'t support transactions\n        autoCommit = true;\n      }      \n      //ä»configurationä¸­å–å‡ºenvironmentå¯¹è±¡\n      final Environment environment = configuration.getEnvironment();\n      //ä»environmentä¸­å–å‡ºTransactionFactory\n      final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);\n      //åˆ›å»ºTransaction\n      final Transaction tx = transactionFactory.newTransaction(connection);\n      //åˆ›å»ºåŒ…å«äº‹åŠ¡æ“ä½œçš„æ‰§è¡Œå™¨\n      final Executor executor = configuration.newExecutor(tx, execType);\n      //æ„å»ºåŒ…å«æ‰§è¡Œå™¨çš„SqlSession\n      return new DefaultSqlSession(configuration, executor, autoCommit);\n    } catch (Exception e) {\n      throw ExceptionFactory.wrapException("Error opening session.  Cause: " + e, e);\n    } finally {\n      ErrorContext.instance().reset();\n    }\n}\n\nprivate TransactionFactory getTransactionFactoryFromEnvironment(Environment environment) {\n    if (environment == null || environment.getTransactionFactory() == null) {\n      return new ManagedTransactionFactory();\n    }\n    //è¿™é‡Œè¿”å›SpringManagedTransactionFactory\n    return environment.getTransactionFactory();\n}\n\n@Override\npublic Transaction newTransaction(DataSource dataSource, TransactionIsolationLevel level, boolean autoCommit) {\n    //åˆ›å»ºSpringManagedTransaction\n    return new SpringManagedTransaction(dataSource);\n}\n')])])]),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("p",[t("a",{attrs:{href:"https://www.cnblogs.com/java-chen-hao/p/11839993.html#_labelTop",target:"_blank",rel:"noopener noreferrer"}},[n._v("å›åˆ°é¡¶éƒ¨"),t("OutboundLink")],1)]),n._v(" "),t("h2",{attrs:{id:"springmanagedtransaction"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#springmanagedtransaction"}},[n._v("#")]),n._v(" SpringManagedTransaction")]),n._v(" "),t("p",[n._v("ä¹Ÿå°±æ˜¯è¯´mybatisçš„æ‰§è¡Œäº‹åŠ¡çš„äº‹åŠ¡ç®¡ç†å™¨å°±åˆ‡æ¢æˆäº†SpringManagedTransactionï¼Œä¸‹é¢æˆ‘ä»¬å†å»çœ‹çœ‹SpringManagedTransactionFactoryç±»çš„æºç ï¼š")]),n._v(" "),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('public class SpringManagedTransaction implements Transaction {\n    private static final Log LOGGER = LogFactory.getLog(SpringManagedTransaction.class);\n    private final DataSource dataSource;\n    private Connection connection;\n    private boolean isConnectionTransactional;\n    private boolean autoCommit;\n\n    public SpringManagedTransaction(DataSource dataSource) {\n        Assert.notNull(dataSource, "No DataSource specified");\n        this.dataSource = dataSource;\n    }\n\n    public Connection getConnection() throws SQLException {\n        if (this.connection == null) {\n            this.openConnection();\n        }\n\n        return this.connection;\n    }\n\n    private void openConnection() throws SQLException {\n        //é€šè¿‡DataSourceUtilsè·å–connectionï¼Œè¿™é‡Œå’ŒJdbcTransactionä¸ä¸€æ ·\n        this.connection = DataSourceUtils.getConnection(this.dataSource);\n        this.autoCommit = this.connection.getAutoCommit();\n        this.isConnectionTransactional = DataSourceUtils.isConnectionTransactional(this.connection, this.dataSource);\n        if (LOGGER.isDebugEnabled()) {\n            LOGGER.debug("JDBC Connection [" + this.connection + "] will" + (this.isConnectionTransactional ? " " : " not ") + "be managed by Spring");\n        }\n\n    }\n\n    public void commit() throws SQLException {\n        if (this.connection != null && !this.isConnectionTransactional && !this.autoCommit) {\n            if (LOGGER.isDebugEnabled()) {\n                LOGGER.debug("Committing JDBC Connection [" + this.connection + "]");\n            }\n            //é€šè¿‡connectionæäº¤ï¼Œè¿™é‡Œå’ŒJdbcTransactionä¸€æ ·\n            this.connection.commit();\n        }\n\n    }\n\n    public void rollback() throws SQLException {\n        if (this.connection != null && !this.isConnectionTransactional && !this.autoCommit) {\n            if (LOGGER.isDebugEnabled()) {\n                LOGGER.debug("Rolling back JDBC Connection [" + this.connection + "]");\n            }\n            //é€šè¿‡connectionå›æ»šï¼Œè¿™é‡Œå’ŒJdbcTransactionä¸€æ ·\n            this.connection.rollback();\n        }\n\n    }\n\n    public void close() throws SQLException {\n        DataSourceUtils.releaseConnection(this.connection, this.dataSource);\n    }\n\n    public Integer getTimeout() throws SQLException {\n        ConnectionHolder holder = (ConnectionHolder)TransactionSynchronizationManager.getResource(this.dataSource);\n        return holder != null && holder.hasTimeout() ? holder.getTimeToLiveInSeconds() : null;\n    }\n}\n')])])]),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("h3",{attrs:{id:"org-springframework-jdbc-datasource-datasourceutils-getconnection"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#org-springframework-jdbc-datasource-datasourceutils-getconnection"}},[n._v("#")]),n._v(" org.springframework.jdbc.datasource.DataSourceUtils#getConnection")]),n._v(" "),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('public static Connection getConnection(DataSource dataSource) throws CannotGetJdbcConnectionException {\n    try {\n        return doGetConnection(dataSource);\n    }\n    catch (SQLException ex) {\n        throw new CannotGetJdbcConnectionException("Could not get JDBC Connection", ex);\n    }\n}\n\npublic static Connection doGetConnection(DataSource dataSource) throws SQLException {\n    Assert.notNull(dataSource, "No DataSource specified");\n    //TransactionSynchronizationManageré‡ç‚¹ï¼ï¼ï¼æœ‰æ²¡æœ‰å¾ˆç†Ÿæ‚‰çš„æ„Ÿè§‰ï¼Ÿï¼Ÿ\n    //è¿˜è®°å¾—æˆ‘ä»¬å‰é¢Springäº‹åŠ¡æºç çš„åˆ†æå—ï¼Ÿ@Transactionä¼šåˆ›å»ºConnectionï¼Œå¹¶æ”¾å…¥ThreadLocalä¸­\n    //è¿™é‡Œä»ThreadLocalä¸­è·å–ConnectionHolder\n    ConnectionHolder conHolder = (ConnectionHolder)TransactionSynchronizationManager.getResource(dataSource);\n    if (conHolder == null || !conHolder.hasConnection() && !conHolder.isSynchronizedWithTransaction()) {\n        logger.debug("Fetching JDBC Connection from DataSource");\n        //å¦‚æœæ²¡æœ‰ä½¿ç”¨@Transactionï¼Œé‚£è°ƒç”¨Mapperæ¥å£æ–¹æ³•æ—¶ï¼Œä¹Ÿæ˜¯é€šè¿‡Springçš„æ–¹æ³•è·å–Connection\n        Connection con = fetchConnection(dataSource);\n        if (TransactionSynchronizationManager.isSynchronizationActive()) {\n            logger.debug("Registering transaction synchronization for JDBC Connection");\n            ConnectionHolder holderToUse = conHolder;\n            if (conHolder == null) {\n                holderToUse = new ConnectionHolder(con);\n            } else {\n                conHolder.setConnection(con);\n            }\n\n            holderToUse.requested();\n            TransactionSynchronizationManager.registerSynchronization(new DataSourceUtils.ConnectionSynchronization(holderToUse, dataSource));\n            holderToUse.setSynchronizedWithTransaction(true);\n            if (holderToUse != conHolder) {\n                //å°†è·å–åˆ°çš„ConnectionHolderæ”¾å…¥ThreadLocalä¸­ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹è°ƒç”¨ä¸‹ä¸€ä¸ªæ¥å£ï¼Œä¸‹ä¸€ä¸ªæ¥å£ä½¿ç”¨äº†Springäº‹åŠ¡ï¼Œé‚£Springäº‹åŠ¡ä¹Ÿå¯ä»¥ç›´æ¥å–åˆ°Mybatisåˆ›å»ºçš„Connection\n                //é€šè¿‡ThreadLocalä¿è¯äº†åŒä¸€çº¿ç¨‹ä¸­Springäº‹åŠ¡ä½¿ç”¨çš„Connectionå’ŒMapperä»£ç†ç±»ä½¿ç”¨çš„Connectionæ˜¯åŒä¸€ä¸ª\n                TransactionSynchronizationManager.bindResource(dataSource, holderToUse);\n            }\n        }\n\n        return con;\n    } else {\n        conHolder.requested();\n        if (!conHolder.hasConnection()) {\n            logger.debug("Fetching resumed JDBC Connection from DataSource");\n            conHolder.setConnection(fetchConnection(dataSource));\n        }\n\n        //æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä¸šåŠ¡ä»£ç ä½¿ç”¨äº†@Transactionæ³¨è§£ï¼Œåœ¨Springä¸­å°±å·²ç»é€šè¿‡dataSourceåˆ›å»ºäº†ä¸€ä¸ªConnectionå¹¶æ”¾å…¥ThreadLocalä¸­\n        //é‚£ä¹ˆå½“Mapperä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œé€šè¿‡SqlSessionçš„SpringManagedTransactionè·å–è¿æ¥æ—¶ï¼Œå°±ç›´æ¥è·å–åˆ°äº†å½“å‰çº¿ç¨‹ä¸­Springäº‹åŠ¡åˆ›å»ºçš„Connectionå¹¶è¿”å›\n        return conHolder.getConnection();\n    }\n}\n')])])]),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("p",[n._v("æƒ³çœ‹æ€ä¹ˆè·å–connHolder")]),n._v(" "),t("h3",{attrs:{id:"org-springframework-transaction-support-transactionsynchronizationmanager-getresource"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#org-springframework-transaction-support-transactionsynchronizationmanager-getresource"}},[n._v("#")]),n._v(" org.springframework.transaction.support.TransactionSynchronizationManager#getResource")]),n._v(" "),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('//ä¿å­˜æ•°æ®åº“è¿æ¥çš„ThreadLocal\nprivate static final ThreadLocal<Map<Object, Object>> resources = new NamedThreadLocal<>("Transactional resources");\n@Nullable\npublic static Object getResource(Object key) {\n    Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);\n    //è·å–ConnectionHolder\n    Object value = doGetResource(actualKey);\n    ....\n    return value;\n}\n\n@Nullable\nprivate static Object doGetResource(Object actualKey) {\n    /**\n     * ä»threadlocal <Map<Object, Object>>ä¸­å–å‡ºæ¥å½“å‰çº¿ç¨‹ç»‘å®šçš„map\n     * mapé‡Œé¢å­˜çš„æ˜¯<dataSource,ConnectionHolder>\n     */\n    Map<Object, Object> map = resources.get();\n    if (map == null) {\n        return null;\n    }\n    //mapä¸­å–å‡ºæ¥å¯¹åº”dataSourceçš„ConnectionHolder\n    Object value = map.get(actualKey);\n    // Transparently remove ResourceHolder that was marked as void...\n    if (value instanceof ResourceHolder && ((ResourceHolder) value).isVoid()) {\n        map.remove(actualKey);\n        // Remove entire ThreadLocal if empty...\n        if (map.isEmpty()) {\n            resources.remove();\n        }\n        value = null;\n    }\n    return value;\n}\n')])])]),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("p",[n._v("æˆ‘ä»¬çœ‹åˆ°ç›´æ¥ä»ThreadLocalä¸­å–å‡ºæ¥çš„conn,è€Œspringè‡ªå·±çš„äº‹åŠ¡ä¹Ÿæ˜¯æ“ä½œçš„è¿™ä¸ªThreadLocalä¸­çš„connæ¥è¿›è¡Œäº‹åŠ¡çš„å¼€å¯å’Œå›æ»šï¼Œç”±æ­¤æˆ‘ä»¬çŸ¥é“äº†åœ¨åŒä¸€çº¿ç¨‹ä¸­Springäº‹åŠ¡ä¸­çš„Connectionå’ŒMybaitsä¸­Mapperä»£ç†å¯¹è±¡ä¸­æ“ä½œæ•°æ®åº“çš„Connectionæ˜¯åŒä¸€ä¸ªï¼Œå½“å–å‡ºæ¥çš„connä¸ºç©ºæ—¶å€™,è°ƒç”¨org.springframework.jdbc.datasource.DataSourceUtils#fetchConnectionè·å–ï¼Œç„¶åæŠŠä»æ•°æ®æºå–å‡ºæ¥çš„è¿æ¥è¿”å›")]),n._v(" "),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('private static Connection fetchConnection(DataSource dataSource) throws SQLException {\n    //ä»æ•°æ®æºå–å‡ºæ¥conn\n    Connection con = dataSource.getConnection();\n    if (con == null) {\n        throw new IllegalStateException("DataSource returned null from getConnection(): " + dataSource);\n    }\n    return con;\n}\n')])])]),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("p",[n._v("æˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹ä¸Šç¯‡æ–‡ç« ä¸­çš„SqlSessionInterceptor")]),n._v(" "),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v(" 1 private class SqlSessionInterceptor implements InvocationHandler {\n 2     private SqlSessionInterceptor() {\n 3     }\n 4 \n 5     public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n 6         SqlSession sqlSession = SqlSessionUtils.getSqlSession(SqlSessionTemplate.this.sqlSessionFactory, SqlSessionTemplate.this.executorType, SqlSessionTemplate.this.exceptionTranslator);\n 7 \n 8         Object unwrapped;\n 9         try {\n10             Object result = method.invoke(sqlSession, args);\n11             // å¦‚æœå½“å‰æ“ä½œæ²¡æœ‰åœ¨ä¸€ä¸ªSpringäº‹åŠ¡ä¸­ï¼Œåˆ™æ‰‹åŠ¨commitä¸€ä¸‹\n12             // å¦‚æœå½“å‰ä¸šåŠ¡æ²¡æœ‰ä½¿ç”¨@Transation,é‚£ä¹ˆæ¯æ¬¡æ‰§è¡Œäº†Mapperæ¥å£çš„æ–¹æ³•ç›´æ¥commit\n13             // è¿˜è®°å¾—æˆ‘ä»¬å‰é¢è®²çš„Mybatisçš„ä¸€çº§ç¼“å­˜å—ï¼Œè¿™é‡Œä¸€çº§ç¼“å­˜ä¸èƒ½èµ·ä½œç”¨äº†ï¼Œå› ä¸ºæ¯æ‰§è¡Œä¸€ä¸ªMapperçš„æ–¹æ³•ï¼ŒsqlSessionéƒ½æäº¤äº†\n14             // sqlSessionæäº¤ï¼Œä¼šæ¸…ç©ºä¸€çº§ç¼“å­˜\n15             if (!SqlSessionUtils.isSqlSessionTransactional(sqlSession, SqlSessionTemplate.this.sqlSessionFactory)) {\n16                 sqlSession.commit(true);\n17             }\n18 \n19             unwrapped = result;\n20         } catch (Throwable var11) {\n21             unwrapped = ExceptionUtil.unwrapThrowable(var11);\n22             if (SqlSessionTemplate.this.exceptionTranslator != null && unwrapped instanceof PersistenceException) {\n23                 SqlSessionUtils.closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory);\n24                 sqlSession = null;\n25                 Throwable translated = SqlSessionTemplate.this.exceptionTranslator.translateExceptionIfPossible((PersistenceException)unwrapped);\n26                 if (translated != null) {\n27                     unwrapped = translated;\n28                 }\n29             }\n30 \n31             throw (Throwable)unwrapped;\n32         } finally {\n33             if (sqlSession != null) {\n34                 SqlSessionUtils.closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory);\n35             }\n36 \n37         }\n38         return unwrapped;\n39     }\n40 }\n")])])]),t("p",[n._v("["),t("img",{attrs:{src:"https://common.cnblogs.com/images/copycode.gif",alt:"å¤åˆ¶ä»£ç "}}),n._v("](javascript:void(0)ğŸ˜‰")]),n._v(" "),t("p",[n._v("çœ‹ç¬¬15å’Œ16è¡Œï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨@Transationï¼ŒMapperæ–¹æ³•æ‰§è¡Œå®Œåï¼ŒsqlSessionå°†ä¼šæäº¤ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡org.springframework.jdbc.datasource.DataSourceUtils#fetchConnectionè·å–åˆ°çš„Connectionå°†ä¼šcommitï¼Œç›¸å½“äºConnectionæ˜¯è‡ªåŠ¨æäº¤çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸ä½¿ç”¨@Transationï¼ŒMybatiså°†æ²¡æœ‰äº‹åŠ¡å¯è¨€ã€‚")]),n._v(" "),t("p",[n._v("Mybatiså’ŒSpringæ•´åˆåSpringManagedTransactionå’ŒSpringçš„Transactionçš„å…³ç³»ï¼š")]),n._v(" "),t("ul",[t("li",[n._v("å¦‚æœå¼€å¯Springäº‹åŠ¡ï¼Œåˆ™å…ˆæœ‰Springçš„Transactionï¼Œç„¶åmybatisåˆ›å»ºsqlSessionæ—¶ï¼Œä¼šåˆ›å»ºSpringManagedTransactionå¹¶åŠ å…¥sqlSessionä¸­ï¼ŒSpringManagedTransactionä¸­çš„connectionä¼šä»Springçš„Transactionåˆ›å»ºçš„Connectionå¹¶æ”¾å…¥ThreadLocalä¸­è·å–")]),n._v(" "),t("li",[n._v("å¦‚æœæ²¡æœ‰å¼€å¯Springäº‹åŠ¡æˆ–è€…ç¬¬ä¸€ä¸ªæ–¹æ³•æ²¡æœ‰äº‹åŠ¡åé¢çš„æ–¹æ³•æœ‰äº‹åŠ¡ï¼Œåˆ™SpringManagedTransactionåˆ›å»ºConnectionå¹¶æ”¾å…¥ThreadLocalä¸­")])]),n._v(" "),t("p",[n._v("springç»“åˆmybatisåmybaitsä¸€çº§ç¼“å­˜å¤±æ•ˆåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š")]),n._v(" "),t("ul",[t("li",[n._v("å¦‚æœæ²¡æœ‰å¼€å¯äº‹åŠ¡ï¼Œæ¯ä¸€æ¬¡sqléƒ½æ˜¯ç”¨çš„æ–°çš„SqlSessionï¼Œè¿™æ—¶mybatisçš„ä¸€çº§ç¼“å­˜æ˜¯å¤±æ•ˆçš„ã€‚")]),n._v(" "),t("li",[n._v("å¦‚æœæœ‰äº‹åŠ¡ï¼ŒåŒä¸€ä¸ªäº‹åŠ¡ä¸­ç›¸åŒçš„æŸ¥è¯¢ä½¿ç”¨çš„ç›¸åŒçš„SqlSessioonï¼Œæ­¤æ—¶ä¸€çº§ç¼“å­˜æ˜¯ç”Ÿæ•ˆçš„ã€‚")])]),n._v(" "),t("p",[n._v("å¦‚æœä½¿ç”¨äº†@Transationå‘¢ï¼Ÿé‚£åœ¨è°ƒç”¨Mapperä»£ç†ç±»çš„æ–¹æ³•ä¹‹å‰å°±å·²ç»é€šè¿‡Springçš„äº‹åŠ¡ç”Ÿæˆäº†Connectionå¹¶æ”¾å…¥ThreadLocalï¼Œå¹¶ä¸”è®¾ç½®äº‹åŠ¡ä¸è‡ªåŠ¨æäº¤ï¼Œå½“å‰çº¿ç¨‹å¤šä¸ªMapperä»£ç†å¯¹è±¡è°ƒç”¨æ•°æ®åº“æ“ä½œæ–¹æ³•æ—¶ï¼Œå°†ä»ThreadLocalè·å–Springåˆ›å»ºçš„connection,åœ¨æ‰€æœ‰çš„Mapperæ–¹æ³•è°ƒç”¨å®Œåï¼ŒSpringäº‹åŠ¡æäº¤æˆ–è€…å›æ»šï¼Œåˆ°æ­¤mybatisçš„äº‹åŠ¡æ˜¯æ€ä¹ˆè¢«springç®¡ç†çš„å°±æ˜¾è€Œæ˜“è§äº†")]),n._v(" "),t("p",[n._v("è¿˜æœ‰æ–‡ç« å¼€å¤´çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆMybtisä¸­è¦é…ç½®dataSourceï¼ŒSpringçš„äº‹åŠ¡ä¸­ä¹Ÿè¦é…ç½®dataSourceï¼Ÿ")]),n._v(" "),t("p",[n._v("å› ä¸ºSpringäº‹åŠ¡åœ¨æ²¡è°ƒç”¨Mapperæ–¹æ³•ä¹‹å‰å°±éœ€è¦å¼€ä¸€ä¸ªConnectionï¼Œå¹¶è®¾ç½®äº‹åŠ¡ä¸è‡ªåŠ¨æäº¤ï¼Œé‚£ä¹ˆtransactionManagerä¸­è‡ªç„¶è¦é…ç½®dataSourceã€‚é‚£å¦‚æœæˆ‘ä»¬çš„Serviceæ²¡æœ‰ç”¨åˆ°Springäº‹åŠ¡å‘¢ï¼Œéš¾é“å°±ä¸éœ€è¦è·å–æ•°æ®åº“è¿æ¥äº†å—ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œæ­¤æ—¶é€šè¿‡SpringManagedTransactionè°ƒç”¨org.springframework.jdbc.datasource.DataSourceUtils#getConnection#fetchConnectionæ–¹æ³•è·å–ï¼Œå¹¶å°†dataSourceä½œä¸ºå‚æ•°ä¼ è¿›å»ï¼Œå®é™…ä¸Šè·å–çš„Connectionéƒ½æ˜¯é€šè¿‡dataSourceæ¥è·å–çš„ã€‚")])])}),[],!1,null,null,null);t.default=e.exports}}]);