<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SQL优化例子 | 一颗牙疼</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.9825735b.css" as="style"><link rel="preload" href="/assets/js/app.f1b473bd.js" as="script"><link rel="preload" href="/assets/js/2.fe0fd2e3.js" as="script"><link rel="preload" href="/assets/js/35.1bd78c05.js" as="script"><link rel="prefetch" href="/assets/js/10.33590986.js"><link rel="prefetch" href="/assets/js/100.f78ba335.js"><link rel="prefetch" href="/assets/js/101.144e6339.js"><link rel="prefetch" href="/assets/js/102.aff501b7.js"><link rel="prefetch" href="/assets/js/103.dce26470.js"><link rel="prefetch" href="/assets/js/104.26548958.js"><link rel="prefetch" href="/assets/js/11.e176da1e.js"><link rel="prefetch" href="/assets/js/12.e17f1dc0.js"><link rel="prefetch" href="/assets/js/13.b24f9ea2.js"><link rel="prefetch" href="/assets/js/14.347b4cb2.js"><link rel="prefetch" href="/assets/js/15.25c18adb.js"><link rel="prefetch" href="/assets/js/16.b82deb5e.js"><link rel="prefetch" href="/assets/js/17.4b8eda5c.js"><link rel="prefetch" href="/assets/js/18.94f035df.js"><link rel="prefetch" href="/assets/js/19.f9f0fb9a.js"><link rel="prefetch" href="/assets/js/20.e0617732.js"><link rel="prefetch" href="/assets/js/21.ded72680.js"><link rel="prefetch" href="/assets/js/22.a7d10053.js"><link rel="prefetch" href="/assets/js/23.2a865452.js"><link rel="prefetch" href="/assets/js/24.78892c84.js"><link rel="prefetch" href="/assets/js/25.754b8f95.js"><link rel="prefetch" href="/assets/js/26.83bff54d.js"><link rel="prefetch" href="/assets/js/27.5f6e1d66.js"><link rel="prefetch" href="/assets/js/28.0d045f90.js"><link rel="prefetch" href="/assets/js/29.df8cae72.js"><link rel="prefetch" href="/assets/js/3.9424d082.js"><link rel="prefetch" href="/assets/js/30.487b6d63.js"><link rel="prefetch" href="/assets/js/31.981a689c.js"><link rel="prefetch" href="/assets/js/32.4054d6a4.js"><link rel="prefetch" href="/assets/js/33.82377f32.js"><link rel="prefetch" href="/assets/js/34.422c6876.js"><link rel="prefetch" href="/assets/js/36.763eef96.js"><link rel="prefetch" href="/assets/js/37.b9f362d0.js"><link rel="prefetch" href="/assets/js/38.81fa7d88.js"><link rel="prefetch" href="/assets/js/39.9d65c1ee.js"><link rel="prefetch" href="/assets/js/4.0b2df6d7.js"><link rel="prefetch" href="/assets/js/40.62236695.js"><link rel="prefetch" href="/assets/js/41.5fe37bc2.js"><link rel="prefetch" href="/assets/js/42.0535a0c4.js"><link rel="prefetch" href="/assets/js/43.959d2b22.js"><link rel="prefetch" href="/assets/js/44.4f5d7e45.js"><link rel="prefetch" href="/assets/js/45.95b3c34a.js"><link rel="prefetch" href="/assets/js/46.54a00035.js"><link rel="prefetch" href="/assets/js/47.5dce1505.js"><link rel="prefetch" href="/assets/js/48.02394ae9.js"><link rel="prefetch" href="/assets/js/49.df5ab6b8.js"><link rel="prefetch" href="/assets/js/5.60d4a913.js"><link rel="prefetch" href="/assets/js/50.f23015f8.js"><link rel="prefetch" href="/assets/js/51.3c1268b6.js"><link rel="prefetch" href="/assets/js/52.582990b8.js"><link rel="prefetch" href="/assets/js/53.336d30d8.js"><link rel="prefetch" href="/assets/js/54.382ffa0c.js"><link rel="prefetch" href="/assets/js/55.b022076f.js"><link rel="prefetch" href="/assets/js/56.d648021f.js"><link rel="prefetch" href="/assets/js/57.daee90c0.js"><link rel="prefetch" href="/assets/js/58.1dc75068.js"><link rel="prefetch" href="/assets/js/59.8e0aa66f.js"><link rel="prefetch" href="/assets/js/6.a104c4e0.js"><link rel="prefetch" href="/assets/js/60.5971fa7d.js"><link rel="prefetch" href="/assets/js/61.b5d38972.js"><link rel="prefetch" href="/assets/js/62.479ee1ec.js"><link rel="prefetch" href="/assets/js/63.9288134c.js"><link rel="prefetch" href="/assets/js/64.fd1fa594.js"><link rel="prefetch" href="/assets/js/65.6d7c8876.js"><link rel="prefetch" href="/assets/js/66.12eb7c68.js"><link rel="prefetch" href="/assets/js/67.ec6b9968.js"><link rel="prefetch" href="/assets/js/68.40a7cbed.js"><link rel="prefetch" href="/assets/js/69.1f663e2c.js"><link rel="prefetch" href="/assets/js/7.661a7c8f.js"><link rel="prefetch" href="/assets/js/70.a4b59650.js"><link rel="prefetch" href="/assets/js/71.d0a17b3b.js"><link rel="prefetch" href="/assets/js/72.ce31e327.js"><link rel="prefetch" href="/assets/js/73.689c681b.js"><link rel="prefetch" href="/assets/js/74.c3ee0764.js"><link rel="prefetch" href="/assets/js/75.631b23c2.js"><link rel="prefetch" href="/assets/js/76.5639d6d8.js"><link rel="prefetch" href="/assets/js/77.535d056c.js"><link rel="prefetch" href="/assets/js/78.4a10c037.js"><link rel="prefetch" href="/assets/js/79.1c4b1b82.js"><link rel="prefetch" href="/assets/js/8.cbcbaa9c.js"><link rel="prefetch" href="/assets/js/80.378f84af.js"><link rel="prefetch" href="/assets/js/81.cd50c718.js"><link rel="prefetch" href="/assets/js/82.fa313785.js"><link rel="prefetch" href="/assets/js/83.5a791c98.js"><link rel="prefetch" href="/assets/js/84.9deb80df.js"><link rel="prefetch" href="/assets/js/85.995a3a07.js"><link rel="prefetch" href="/assets/js/86.364d88cb.js"><link rel="prefetch" href="/assets/js/87.20848abb.js"><link rel="prefetch" href="/assets/js/88.b816d218.js"><link rel="prefetch" href="/assets/js/89.6bf9b49e.js"><link rel="prefetch" href="/assets/js/9.bbc07289.js"><link rel="prefetch" href="/assets/js/90.9e0ab005.js"><link rel="prefetch" href="/assets/js/91.5e91a1b3.js"><link rel="prefetch" href="/assets/js/92.64c206ac.js"><link rel="prefetch" href="/assets/js/93.8af7b9b1.js"><link rel="prefetch" href="/assets/js/94.83bb9556.js"><link rel="prefetch" href="/assets/js/95.1690cd1a.js"><link rel="prefetch" href="/assets/js/96.66883dcc.js"><link rel="prefetch" href="/assets/js/97.59f65ae5.js"><link rel="prefetch" href="/assets/js/98.0bf9d181.js"><link rel="prefetch" href="/assets/js/99.0fdea2a2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9825735b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="一颗牙疼" class="logo"> <span class="site-name can-hide">一颗牙疼</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/01.Java/" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="https://github.com/Atoothache/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/01.Java/" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="https://github.com/Atoothache/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/03.数据库/SQL优化例子.html" class="active sidebar-link">SQL优化例子</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/03.数据库/SQL执行计划比对.html" class="sidebar-link">SQL执行计划比对</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/03.数据库/SQL调优工具.html" class="sidebar-link">SQL调优工具</a></li><li><a href="/03.数据库/javaEE之数据库及数据源.html" class="sidebar-link">javaEE之数据库及数据源</a></li><li><a href="/03.数据库/oracle与Mysql区别.html" class="sidebar-link">oracle与Mysql区别</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Oracle</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>脚本语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模板引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全认证</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>搜索引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Netty</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sql优化例子"><a href="#sql优化例子" class="header-anchor">#</a> SQL优化例子</h1> <h3 id="_1-分页优化"><a href="#_1-分页优化" class="header-anchor">#</a> 1.分页优化</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 
<span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> A<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM RN 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> TABLE_NAME<span class="token punctuation">)</span> A 
<span class="token keyword">WHERE</span> ROWNUM <span class="token operator">&lt;=</span> <span class="token number">40</span>
<span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> RN <span class="token operator">&gt;=</span> <span class="token number">21</span>
</code></pre></div><p><strong>其中最内层的查询SELECT * FROM TABLE_NAME表示不进行翻页的原始查询语句。ROWNUM &lt;= 40和RN &gt;= 21控制分页查询的每页的范围。</strong></p> <p><strong>上面给出的这个分页查询语句，在大多数情况拥有较高的效率。分页的目的就是控制输出结果集大小，将结果尽快的返回。在上面的分页查询语句中，这种考虑主要体现在WHERE ROWNUM &lt;= 40这句上。</strong></p> <p><strong>选择第21到40条记录存在两种方法，一种是上面例子中展示的在查询的第二层通过ROWNUM &lt;= 40来控制最大值，在查询的最外层控制最小值。而另一种方式是去掉查询第二层的WHERE ROWNUM &lt;= 40语句，在查询的最外层控制分页的最小值和最大值。这是，查询语句如下：</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 
<span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> A<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM RN 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> TABLE_NAME<span class="token punctuation">)</span> A 
<span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> RN <span class="token operator">BETWEEN</span> <span class="token number">21</span> <span class="token operator">AND</span> <span class="token number">40</span>
</code></pre></div><p><strong>对比这两种写法，绝大多数的情况下，第一个查询的效率比第二个高得多。</strong></p> <p><strong>这是由于CBO优化模式下，Oracle可以将外层的查询条件推到内层查询中，以提高内层查询的执行效率。对于第一个查询语句，第二层的查询条件WHERE ROWNUM &lt;= 40就可以被Oracle推入到内层查询中，这样Oracle查询的结果一旦超过了ROWNUM限制条件，就终止查询将结果返回了。</strong></p> <p><strong>而第二个查询语句，由于查询条件BETWEEN 21 AND 40是存在于查询的第三层，而Oracle无法将第三层的查询条件推到最内层（即使推到最内层也没有意义，因为最内层查询不知道RN代表什么）。因此，对于第二个查询语句，Oracle最内层返回给中间层的是所有满足条件的数据，而中间层返回给最外层的也是所有数据。数据的过滤在最外层完成，显然这个效率要比第一个查询低得多。</strong></p> <p><strong>上面分析的查询不仅仅是针对单表的简单查询，对于最内层查询是复杂的多表联合查询或最内层查询包含排序的情况一样有效。</strong></p> <h3 id="_2-instr函数"><a href="#_2-instr函数" class="header-anchor">#</a> 2.instr函数</h3> <h4 id="_1-代替like使用"><a href="#_1-代替like使用" class="header-anchor">#</a> 1.代替like使用</h4> <p>（1）instr( mc, 'XXX' ) = 1 代替  mc  like ‘XXX%’</p> <p><strong>不建议代替</strong>，因为当mc创建了索引时前缀匹配会使用索引，这时候如果instr函数代替了不会走索引，会全表扫描</p> <p>（2）instr( mc, 'XXX' ) &gt; 0 代替 mc  like ‘%XXX%’</p> <p><strong>建议代替</strong>，若是在mc字段上没有加索引，两者效率差不多，基本没有区别，但是再mc加上索引后，这样的语句查询，效率可以提高不少，表数据量越大时两者差别越大。。（instr再执行过程显示都是没有使用索引的，但是ORACLE内建的一些函数，是经过相当程度的优化的。）</p> <p>网上有些说是Oracle可以建立函数索引，所以 instr建立索引后会走索引：create index INDEX_NAME on TABLE (instr( mc, 'XXX' ))    但是！！！这里有个坑：在这里函数索引中的XXX是一个动态的参数，不是固定的，所以这样就无法建立函数索引。</p> <h3 id="_2-代替or使用"><a href="#_2-代替or使用" class="header-anchor">#</a> 2.代替or使用：</h3> <p>select id, name from users where instr('101914, 104703', id) &gt; 0;它等价于</p> <p>select id, name from users where id = 101914 or id = 104703;</p> <h3 id="_3-耗时高的查询可以增加查询条件"><a href="#_3-耗时高的查询可以增加查询条件" class="header-anchor">#</a> 3.耗时高的查询可以增加查询条件</h3> <h3 id="_4-like与-性能对比"><a href="#_4-like与-性能对比" class="header-anchor">#</a> 4.like与=性能对比</h3> <p>（1）无索引情况下，一样</p> <p>（2）有索引情况下，=性能高</p> <p><a href="https://blog.csdn.net/weixin_42116650/article/details/114887914" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_5-切勿将子查询放在查询字段上"><a href="#_5-切勿将子查询放在查询字段上" class="header-anchor">#</a> 5.切勿将子查询放在查询字段上</h3> <div class="language-sql extra-class"><pre class="language-sql"><code>例如：<span class="token keyword">SELECT</span> RY<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span>子查询<span class="token punctuation">)</span> SASL <span class="token keyword">FROM</span> T_DAK_RYXX RY
</code></pre></div><p>此结果将会造成每个条查询结果都会执行一次子查询，在分页情况下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span>  <span class="token keyword">SELECT</span> TMP_PAGE<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM PAGEHELPER_ROW_ID <span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
        <span class="token keyword">SELECT</span> RY<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span>子查询<span class="token punctuation">)</span> SASL <span class="token keyword">FROM</span> T_DAK_RYXX RY
<span class="token punctuation">)</span> TMP_PAGE<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> PAGEHELPER_ROW_ID <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token operator">AND</span> PAGEHELPER_ROW_ID <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>假设总数量有一百万条数据，分页只查出前十条，那么结果是这一百万条数据都会执行这个子查询</p> <p>优化1：将子查询往外提</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span>子查询<span class="token punctuation">)</span> SASL <span class="token keyword">FROM</span> <span class="token punctuation">(</span>  <span class="token keyword">SELECT</span> TMP_PAGE<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM PAGEHELPER_ROW_ID <span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
        <span class="token keyword">SELECT</span> RY<span class="token punctuation">.</span><span class="token operator">*</span>  <span class="token keyword">FROM</span> T_DAK_RYXX RY
<span class="token punctuation">)</span> TMP_PAGE<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> PAGEHELPER_ROW_ID <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token operator">AND</span> PAGEHELPER_ROW_ID <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>这样就只有分页的十条结果回去执行子查询，不推荐，因为一般分页sql是插件层加入的不好修改</p> <p>优化2：将子查询改为连接查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 这里列举一个复杂的例子（分页sql这边没有写出来）</span>
<span class="token comment">-- t_dak_ryxx 人员表</span>
<span class="token comment">-- t_bjzf_ajjbxx 案件表</span>
<span class="token comment">-- t_dak_dxajay_gl   人员案件关联表</span>
<span class="token comment">-- 原sql：</span>
<span class="token keyword">SELECT</span> RY<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token punctuation">,</span>   
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span>AJBH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> T_BJZF_AJJBXX A <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> T_DAK_DXAJAY_GL GL <span class="token keyword">ON</span> A<span class="token punctuation">.</span>AJBH <span class="token operator">=</span> GL<span class="token punctuation">.</span>AJBH <span class="token keyword">WHERE</span> GL<span class="token punctuation">.</span>DXID <span class="token operator">=</span> RY<span class="token punctuation">.</span>ID <span class="token operator">AND</span>  A<span class="token punctuation">.</span>SFGD <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">)</span> SASL 
<span class="token keyword">FROM</span> T_DAK_RYXX RY

<span class="token comment">-- 优化后</span>
<span class="token keyword">SELECT</span> ry<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token punctuation">,</span> sl<span class="token punctuation">.</span>sasl <span class="token keyword">FROM</span> t_dak_ryxx ry  
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> gl<span class="token punctuation">.</span>dxid id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> a<span class="token punctuation">.</span>ajbh<span class="token punctuation">)</span> sasl <span class="token keyword">from</span> t_dak_dxajay_gl gl <span class="token keyword">left</span> <span class="token keyword">join</span> t_bjzf_ajjbxx a <span class="token keyword">on</span> a<span class="token punctuation">.</span>ajbh <span class="token operator">=</span> gl<span class="token punctuation">.</span>ajbh <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> gl<span class="token punctuation">.</span>dxid<span class="token punctuation">)</span> sl 
<span class="token keyword">on</span> sl<span class="token punctuation">.</span>id <span class="token operator">=</span> ry<span class="token punctuation">.</span>id
</code></pre></div><h3 id="_6-in与exists"><a href="#_6-in与exists" class="header-anchor">#</a> 6.in与exists</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- t_dak_ryxx 人员表  100W</span>
<span class="token comment">-- t_bjzf_ajjbxx 案件表   13W</span>
<span class="token comment">-- t_dak_dxajay_gl   人员案件关联表   300W</span>

<span class="token comment">-- in</span>
<span class="token keyword">select</span> ry<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> t_dak_ryxx ry  <span class="token keyword">WHERE</span>  ry<span class="token punctuation">.</span>id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> gl<span class="token punctuation">.</span>dxid <span class="token keyword">from</span> t_dak_dxajay_gl gl <span class="token keyword">left</span> <span class="token keyword">join</span> t_bjzf_ajjbxx aj <span class="token keyword">on</span> gl<span class="token punctuation">.</span>ajbh <span class="token operator">=</span> aj<span class="token punctuation">.</span>ajbh <span class="token keyword">where</span> aj<span class="token punctuation">.</span>ajmc <span class="token operator">like</span>  <span class="token string">'%未转区定工%'</span> <span class="token punctuation">)</span>

<span class="token comment">-- exists</span>
<span class="token keyword">select</span> ry<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> t_dak_ryxx ry  <span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>dxid<span class="token punctuation">)</span> <span class="token keyword">from</span> t_dak_dxajay_gl gl <span class="token keyword">left</span> <span class="token keyword">join</span> t_bjzf_ajjbxx aj <span class="token keyword">on</span> gl<span class="token punctuation">.</span>ajbh <span class="token operator">=</span> aj<span class="token punctuation">.</span>ajbh <span class="token keyword">where</span>  aj<span class="token punctuation">.</span>ajmc <span class="token operator">like</span>  <span class="token string">'%未转区定工%'</span>  <span class="token operator">and</span> ry<span class="token punctuation">.</span>id <span class="token operator">=</span> gl<span class="token punctuation">.</span>dxid<span class="token punctuation">)</span>

<span class="token comment">-- join优化（不过执行计划已经帮我们优化了）</span>
<span class="token keyword">select</span> ry<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> t_dak_ryxx ry <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>dxid<span class="token punctuation">)</span> <span class="token keyword">from</span> t_dak_dxajay_gl gl <span class="token keyword">left</span> <span class="token keyword">join</span> t_bjzf_ajjbxx aj <span class="token keyword">on</span> gl<span class="token punctuation">.</span>ajbh <span class="token operator">=</span> aj<span class="token punctuation">.</span>ajbh <span class="token keyword">where</span>  aj<span class="token punctuation">.</span>ajmc <span class="token operator">like</span>  <span class="token string">'%未转区定工%'</span> <span class="token punctuation">)</span> son <span class="token keyword">on</span> ry<span class="token punctuation">.</span>id <span class="token operator">=</span> son<span class="token punctuation">.</span>dxid 
</code></pre></div><p>以上三种情况在执行计划基本一致，执行效率基本一样</p> <p><strong>in</strong></p> <p>-- ORACLE执行计划</p> <div class="language-sql extra-class"><pre class="language-sql"><code>
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
<span class="token operator">|</span> Id  <span class="token operator">|</span> Operation             <span class="token operator">|</span> Name            <span class="token operator">|</span> <span class="token keyword">Rows</span>  <span class="token operator">|</span> Bytes <span class="token operator">|</span>TempSpc<span class="token operator">|</span> Cost <span class="token punctuation">(</span><span class="token operator">%</span>CPU<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token keyword">Time</span>     <span class="token operator">|</span>
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> STATEMENT      <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">23</span>M<span class="token operator">|</span>       <span class="token operator">|</span> <span class="token number">26533</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">05</span>:<span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  SORT <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>        <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">23</span>M<span class="token operator">|</span>    <span class="token number">25</span>M<span class="token operator">|</span> <span class="token number">26533</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">05</span>:<span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">2</span> <span class="token operator">|</span>   <span class="token keyword">HASH</span> <span class="token keyword">JOIN</span> <span class="token keyword">RIGHT</span> SEMI<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">23</span>M<span class="token operator">|</span>  <span class="token number">6768</span>K<span class="token operator">|</span> <span class="token number">21036</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">04</span>:<span class="token number">13</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span>    <span class="token keyword">VIEW</span>               <span class="token operator">|</span> VW_NSO_1        <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>  <span class="token number">4958</span>K<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">9203</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">51</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">4</span> <span class="token operator">|</span>     <span class="token keyword">HASH</span> <span class="token keyword">JOIN</span>         <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">15</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">9203</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">51</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">5</span> <span class="token operator">|</span>      <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> T_BJZF_AJJBXX   <span class="token operator">|</span>  <span class="token number">6559</span> <span class="token operator">|</span>   <span class="token number">281</span>K<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">1097</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">14</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">6</span> <span class="token operator">|</span>      <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> T_DAK_DXAJAY_GL <span class="token operator">|</span>  <span class="token number">2906</span>K<span class="token operator">|</span>   <span class="token number">163</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">8098</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">38</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">7</span> <span class="token operator">|</span>    <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span>  <span class="token operator">|</span> T_DAK_RYXX      <span class="token operator">|</span>   <span class="token number">969</span>K<span class="token operator">|</span>   <span class="token number">119</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">5040</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">01</span> <span class="token operator">|</span>
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
 
Predicate Information <span class="token punctuation">(</span>identified <span class="token keyword">by</span> operation id<span class="token punctuation">)</span>:
<span class="token comment">---------------------------------------------------</span>
 
   <span class="token number">2</span> <span class="token operator">-</span> access<span class="token punctuation">(</span><span class="token string">&quot;RY&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ID&quot;</span><span class="token operator">=</span><span class="token string">&quot;DXID&quot;</span><span class="token punctuation">)</span>
   <span class="token number">4</span> <span class="token operator">-</span> access<span class="token punctuation">(</span><span class="token string">&quot;GL&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJBH&quot;</span><span class="token operator">=</span><span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJBH&quot;</span><span class="token punctuation">)</span>
   <span class="token number">5</span> <span class="token operator">-</span> filter<span class="token punctuation">(</span><span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJMC&quot;</span> <span class="token operator">LIKE</span> <span class="token string">'%未转区定工%'</span> <span class="token operator">AND</span> <span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJMC&quot;</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
   
</code></pre></div><p>--MYSQL</p> <p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20221028093432796.png" alt="image-20221028093432796"></p> <p><strong>exists    与in一模一样</strong></p> <p>-- ORACLE执行计划</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">Plan</span> <span class="token keyword">hash</span> <span class="token keyword">value</span>: <span class="token number">3201351420</span>
 
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
<span class="token operator">|</span> Id  <span class="token operator">|</span> Operation             <span class="token operator">|</span> Name            <span class="token operator">|</span> <span class="token keyword">Rows</span>  <span class="token operator">|</span> Bytes <span class="token operator">|</span>TempSpc<span class="token operator">|</span> Cost <span class="token punctuation">(</span><span class="token operator">%</span>CPU<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token keyword">Time</span>     <span class="token operator">|</span>
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> STATEMENT      <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">23</span>M<span class="token operator">|</span>       <span class="token operator">|</span> <span class="token number">26533</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">05</span>:<span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  SORT <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>        <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">23</span>M<span class="token operator">|</span>    <span class="token number">25</span>M<span class="token operator">|</span> <span class="token number">26533</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">05</span>:<span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">2</span> <span class="token operator">|</span>   <span class="token keyword">HASH</span> <span class="token keyword">JOIN</span> <span class="token keyword">RIGHT</span> SEMI<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">23</span>M<span class="token operator">|</span>  <span class="token number">6768</span>K<span class="token operator">|</span> <span class="token number">21036</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">04</span>:<span class="token number">13</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span>    <span class="token keyword">VIEW</span>               <span class="token operator">|</span> VW_SQ_1         <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>  <span class="token number">4958</span>K<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">9203</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">51</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">4</span> <span class="token operator">|</span>     <span class="token keyword">HASH</span> <span class="token keyword">JOIN</span>         <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">15</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">9203</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">51</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">5</span> <span class="token operator">|</span>      <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> T_BJZF_AJJBXX   <span class="token operator">|</span>  <span class="token number">6559</span> <span class="token operator">|</span>   <span class="token number">281</span>K<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">1097</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">14</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">6</span> <span class="token operator">|</span>      <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> T_DAK_DXAJAY_GL <span class="token operator">|</span>  <span class="token number">2906</span>K<span class="token operator">|</span>   <span class="token number">163</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">8098</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">38</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">7</span> <span class="token operator">|</span>    <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span>  <span class="token operator">|</span> T_DAK_RYXX      <span class="token operator">|</span>   <span class="token number">969</span>K<span class="token operator">|</span>   <span class="token number">119</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">5040</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">01</span> <span class="token operator">|</span>
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
 
Predicate Information <span class="token punctuation">(</span>identified <span class="token keyword">by</span> operation id<span class="token punctuation">)</span>:
<span class="token comment">---------------------------------------------------</span>
 
   <span class="token number">2</span> <span class="token operator">-</span> access<span class="token punctuation">(</span><span class="token string">&quot;RY&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ID&quot;</span><span class="token operator">=</span><span class="token string">&quot;ITEM_1&quot;</span><span class="token punctuation">)</span>
   <span class="token number">4</span> <span class="token operator">-</span> access<span class="token punctuation">(</span><span class="token string">&quot;GL&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJBH&quot;</span><span class="token operator">=</span><span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJBH&quot;</span><span class="token punctuation">)</span>
   <span class="token number">5</span> <span class="token operator">-</span> filter<span class="token punctuation">(</span><span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJMC&quot;</span> <span class="token operator">LIKE</span> <span class="token string">'%未转区定工%'</span> <span class="token operator">AND</span> <span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJMC&quot;</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
</code></pre></div><p>--MYSQL</p> <p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20221028093732827.png" alt="image-20221028093732827"></p> <p><strong>join</strong></p> <p>--ORALCE</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">Plan</span> <span class="token keyword">hash</span> <span class="token keyword">value</span>: <span class="token number">2347808857</span>
 
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
<span class="token operator">|</span> Id  <span class="token operator">|</span> Operation             <span class="token operator">|</span> Name            <span class="token operator">|</span> <span class="token keyword">Rows</span>  <span class="token operator">|</span> Bytes <span class="token operator">|</span>TempSpc<span class="token operator">|</span> Cost <span class="token punctuation">(</span><span class="token operator">%</span>CPU<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token keyword">Time</span>     <span class="token operator">|</span>
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> STATEMENT      <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">21</span>M<span class="token operator">|</span>       <span class="token operator">|</span> <span class="token number">24537</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">04</span>:<span class="token number">55</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">1</span> <span class="token operator">|</span>  <span class="token keyword">HASH</span> <span class="token keyword">JOIN</span>            <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">21</span>M<span class="token operator">|</span>  <span class="token number">4512</span>K<span class="token operator">|</span> <span class="token number">24537</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">04</span>:<span class="token number">55</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span>   <span class="token keyword">VIEW</span>                <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>  <span class="token number">2704</span>K<span class="token operator">|</span>       <span class="token operator">|</span> <span class="token number">12814</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">02</span>:<span class="token number">34</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span>    <span class="token keyword">HASH</span> <span class="token keyword">UNIQUE</span>        <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">15</span>M<span class="token operator">|</span>    <span class="token number">16</span>M<span class="token operator">|</span> <span class="token number">12814</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">02</span>:<span class="token number">34</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">4</span> <span class="token operator">|</span>     <span class="token keyword">HASH</span> <span class="token keyword">JOIN</span>         <span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token number">153</span>K<span class="token operator">|</span>    <span class="token number">15</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">9203</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">51</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">5</span> <span class="token operator">|</span>      <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> T_BJZF_AJJBXX   <span class="token operator">|</span>  <span class="token number">6559</span> <span class="token operator">|</span>   <span class="token number">281</span>K<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">1097</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">14</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">6</span> <span class="token operator">|</span>      <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> T_DAK_DXAJAY_GL <span class="token operator">|</span>  <span class="token number">2906</span>K<span class="token operator">|</span>   <span class="token number">163</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">8098</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">38</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">7</span> <span class="token operator">|</span>   <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span>   <span class="token operator">|</span> T_DAK_RYXX      <span class="token operator">|</span>   <span class="token number">969</span>K<span class="token operator">|</span>   <span class="token number">119</span>M<span class="token operator">|</span>       <span class="token operator">|</span>  <span class="token number">5040</span>   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token number">00</span>:<span class="token number">01</span>:<span class="token number">01</span> <span class="token operator">|</span>
<span class="token comment">-------------------------------------------------------------------------------------------------</span>
 
Predicate Information <span class="token punctuation">(</span>identified <span class="token keyword">by</span> operation id<span class="token punctuation">)</span>:
<span class="token comment">---------------------------------------------------</span>
 
   <span class="token number">1</span> <span class="token operator">-</span> access<span class="token punctuation">(</span><span class="token string">&quot;RY&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ID&quot;</span><span class="token operator">=</span><span class="token string">&quot;SON&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;DXID&quot;</span><span class="token punctuation">)</span>
   <span class="token number">4</span> <span class="token operator">-</span> access<span class="token punctuation">(</span><span class="token string">&quot;GL&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJBH&quot;</span><span class="token operator">=</span><span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJBH&quot;</span><span class="token punctuation">)</span>
   <span class="token number">5</span> <span class="token operator">-</span> filter<span class="token punctuation">(</span><span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJMC&quot;</span> <span class="token operator">LIKE</span> <span class="token string">'%未转区定工%'</span> <span class="token operator">AND</span> <span class="token string">&quot;AJ&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;AJMC&quot;</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
</code></pre></div><p>--MYSQL</p> <p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20221028094037378.png" alt="image-20221028094037378"></p> <p>结论：in与exists优化后都是使用SEMI  JOIN也就是半连接，ORACLE执行计划中都是用了HASH JOIN RIGHT SEMI，这基本就是跟我们优化后的语句 先对子查询去重再JOIN内连接一样。</p> <h3 id="_7-半连接优化为内连接-只要确保半连接-次表-的关联健唯一即可"><a href="#_7-半连接优化为内连接-只要确保半连接-次表-的关联健唯一即可" class="header-anchor">#</a> 7.半连接优化为内连接（只要确保半连接 次表 的关联健唯一即可）</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">PLAN</span> <span class="token keyword">FOR</span>
<span class="token keyword">SELECT</span> RY<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> T_DAK_RYXX RY <span class="token keyword">WHERE</span>  RY<span class="token punctuation">.</span>ZJLBDM <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ZJ<span class="token punctuation">.</span>ZJLBDM <span class="token keyword">FROM</span> T_DM_MS_ZJLBDM ZJ <span class="token keyword">WHERE</span>  ZJ<span class="token punctuation">.</span>ZJLBMC <span class="token operator">LIKE</span>  <span class="token string">'%港澳通行证%'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>dbms_xplan<span class="token punctuation">.</span>display<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- T_DM_MS_ZJLBDM.ZJLBDM没加主键时  使用 HASH JOIN RIGHT SEMI </span>
<span class="token comment">-- T_DM_MS_ZJLBDM.ZJLBDM加主键时    被执行计划优化为内连接 HASH JOIN</span>
</code></pre></div><h3 id="_8-mysql-distinct效率低原因"><a href="#_8-mysql-distinct效率低原因" class="header-anchor">#</a> 8.MYSQL distinct效率低原因</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- T_DAK_DXAJAY_GL 有dxid，ajbh，ayid三个字段   数据量近300w</span>

<span class="token number">1.</span>不去重
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> DXID <span class="token keyword">FROM</span> T_DAK_DXAJAY_GL <span class="token keyword">WHERE</span> AJBH <span class="token operator">like</span> <span class="token string">'A82130151000020221011100%'</span><span class="token punctuation">;</span>
<span class="token comment">-- 558多条</span>

<span class="token comment">-- 两个字段均无索引   耗时2.2s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		<span class="token keyword">ALL</span>					<span class="token number">2890080</span>	<span class="token number">11.11</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span>
<span class="token comment">-- dxid加了普通索引  耗时2.2s ？？？   以下是执行计划：  </span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		<span class="token keyword">ALL</span>					<span class="token number">2889188</span>	<span class="token number">11.11</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span>
<span class="token comment">-- dxid，ajbh加了复合索引  耗时1.9s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		<span class="token keyword">index</span>	dxid_ajbh	dxid_ajbh	<span class="token number">262</span>		<span class="token number">2890080</span>	<span class="token number">11.11</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>
<span class="token comment">-- dxid，ajbh，ayid加了复合主键索引  耗时1s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		<span class="token keyword">index</span>	<span class="token keyword">PRIMARY</span>	<span class="token keyword">PRIMARY</span>	<span class="token number">390</span>		<span class="token number">2890657</span>	<span class="token number">11.11</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>
<span class="token comment">-- dxid，ajbh，ayid各自加索引  耗时0.033s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		range	ajbh	ajbh	<span class="token number">131</span>		<span class="token number">57</span>	<span class="token number">100</span>	<span class="token keyword">Using</span> <span class="token keyword">index</span> condition


<span class="token number">2.</span>去重
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> DXID <span class="token keyword">FROM</span> T_DAK_DXAJAY_GL <span class="token keyword">WHERE</span> AJBH <span class="token operator">like</span> <span class="token string">'A82130151000020221011100%'</span><span class="token punctuation">;</span>
<span class="token comment">-- 186条</span>

<span class="token comment">-- 两个字段均无索引   耗时2s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		<span class="token keyword">ALL</span>					<span class="token number">2747883</span>	<span class="token number">11.11</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">temporary</span>

<span class="token comment">-- dxid加了普通索引  耗时21s ？？？   以下是执行计划：  </span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		<span class="token keyword">index</span>	dxid	dxid	<span class="token number">131</span>		<span class="token number">2747883</span>	<span class="token number">11.11</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span>
分析原因是这里使用了索引

<span class="token comment">-- dxid，ajbh加了复合索引  耗时1.8s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		<span class="token keyword">index</span>	dxid_ajbh	dxid_ajbh	<span class="token number">262</span>		<span class="token number">2890080</span>	<span class="token number">11.11</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>

<span class="token comment">-- ajbh，dxid加了复合索引  耗时0.028s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		range	ajbh_dxid	ajbh_dxid	<span class="token number">131</span>		<span class="token number">57</span>	<span class="token number">100</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">temporary</span>

<span class="token comment">-- dxid，ajbh，ayid加了复合主键索引  耗时1s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		<span class="token keyword">index</span>	<span class="token keyword">PRIMARY</span>	<span class="token keyword">PRIMARY</span>	<span class="token number">390</span>		<span class="token number">2890657</span>	<span class="token number">11.11</span>	<span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>

<span class="token comment">-- dxid，ajbh，ayid各自加索引/或只加ajbh索引  耗时0.033s    以下是执行计划：</span>
<span class="token number">1</span>	<span class="token keyword">SIMPLE</span>	T_DAK_DXAJAY_GL		range	dxid<span class="token punctuation">,</span>ajbh	ajbh	<span class="token number">131</span>		<span class="token number">57</span>	<span class="token number">100</span>	<span class="token keyword">Using</span> <span class="token keyword">index</span> condition<span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">temporary</span>

</code></pre></div><p>结点1：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 外连接下，优化器无法改变驱动表，只能是外（内）表为驱动表，但是如果外连接被优化为内连接，那么就能进一步优化改变子（外）表为驱动表</span>
<span class="token comment">-- 外连接被优化为内连接的条件可以自行百度！</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">PLAN</span> <span class="token keyword">FOR</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_dak_dxajay_gl gl <span class="token keyword">left</span> <span class="token keyword">join</span> t_bjzf_ajjbxx aj <span class="token keyword">on</span> gl<span class="token punctuation">.</span>ajbh <span class="token operator">=</span> aj<span class="token punctuation">.</span>ajbh <span class="token keyword">where</span>  
<span class="token comment">-- 											aj.ajmc like  '%未转区定工%' ;</span>
											gl<span class="token punctuation">.</span>aybh <span class="token operator">=</span>  <span class="token string">'000102'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>dbms_xplan<span class="token punctuation">.</span>display<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>位图索引用于重复路比较高的比如性别</p> <p>哈希索引查询快但不适用范围查询</p> <p>b-tree索引适用范围查询</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/02.Spring/静态变量注入bean.html" class="prev">
        静态变量注入bean，@Autowire的注入时期
      </a></span> <span class="next"><a href="/03.数据库/SQL执行计划比对.html">
        SQL执行计划比对
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f1b473bd.js" defer></script><script src="/assets/js/2.fe0fd2e3.js" defer></script><script src="/assets/js/35.1bd78c05.js" defer></script>
  </body>
</html>
