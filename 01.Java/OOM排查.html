<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OOM排查 | 一颗牙疼</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.9825735b.css" as="style"><link rel="preload" href="/assets/js/app.f1b473bd.js" as="script"><link rel="preload" href="/assets/js/2.fe0fd2e3.js" as="script"><link rel="preload" href="/assets/js/9.bbc07289.js" as="script"><link rel="prefetch" href="/assets/js/10.33590986.js"><link rel="prefetch" href="/assets/js/100.f78ba335.js"><link rel="prefetch" href="/assets/js/101.144e6339.js"><link rel="prefetch" href="/assets/js/102.aff501b7.js"><link rel="prefetch" href="/assets/js/103.dce26470.js"><link rel="prefetch" href="/assets/js/104.26548958.js"><link rel="prefetch" href="/assets/js/11.e176da1e.js"><link rel="prefetch" href="/assets/js/12.e17f1dc0.js"><link rel="prefetch" href="/assets/js/13.b24f9ea2.js"><link rel="prefetch" href="/assets/js/14.347b4cb2.js"><link rel="prefetch" href="/assets/js/15.25c18adb.js"><link rel="prefetch" href="/assets/js/16.b82deb5e.js"><link rel="prefetch" href="/assets/js/17.4b8eda5c.js"><link rel="prefetch" href="/assets/js/18.94f035df.js"><link rel="prefetch" href="/assets/js/19.f9f0fb9a.js"><link rel="prefetch" href="/assets/js/20.e0617732.js"><link rel="prefetch" href="/assets/js/21.ded72680.js"><link rel="prefetch" href="/assets/js/22.a7d10053.js"><link rel="prefetch" href="/assets/js/23.2a865452.js"><link rel="prefetch" href="/assets/js/24.78892c84.js"><link rel="prefetch" href="/assets/js/25.754b8f95.js"><link rel="prefetch" href="/assets/js/26.83bff54d.js"><link rel="prefetch" href="/assets/js/27.5f6e1d66.js"><link rel="prefetch" href="/assets/js/28.0d045f90.js"><link rel="prefetch" href="/assets/js/29.df8cae72.js"><link rel="prefetch" href="/assets/js/3.9424d082.js"><link rel="prefetch" href="/assets/js/30.487b6d63.js"><link rel="prefetch" href="/assets/js/31.981a689c.js"><link rel="prefetch" href="/assets/js/32.4054d6a4.js"><link rel="prefetch" href="/assets/js/33.82377f32.js"><link rel="prefetch" href="/assets/js/34.422c6876.js"><link rel="prefetch" href="/assets/js/35.1bd78c05.js"><link rel="prefetch" href="/assets/js/36.763eef96.js"><link rel="prefetch" href="/assets/js/37.b9f362d0.js"><link rel="prefetch" href="/assets/js/38.81fa7d88.js"><link rel="prefetch" href="/assets/js/39.9d65c1ee.js"><link rel="prefetch" href="/assets/js/4.0b2df6d7.js"><link rel="prefetch" href="/assets/js/40.62236695.js"><link rel="prefetch" href="/assets/js/41.5fe37bc2.js"><link rel="prefetch" href="/assets/js/42.0535a0c4.js"><link rel="prefetch" href="/assets/js/43.959d2b22.js"><link rel="prefetch" href="/assets/js/44.4f5d7e45.js"><link rel="prefetch" href="/assets/js/45.95b3c34a.js"><link rel="prefetch" href="/assets/js/46.54a00035.js"><link rel="prefetch" href="/assets/js/47.5dce1505.js"><link rel="prefetch" href="/assets/js/48.02394ae9.js"><link rel="prefetch" href="/assets/js/49.df5ab6b8.js"><link rel="prefetch" href="/assets/js/5.60d4a913.js"><link rel="prefetch" href="/assets/js/50.f23015f8.js"><link rel="prefetch" href="/assets/js/51.3c1268b6.js"><link rel="prefetch" href="/assets/js/52.582990b8.js"><link rel="prefetch" href="/assets/js/53.336d30d8.js"><link rel="prefetch" href="/assets/js/54.382ffa0c.js"><link rel="prefetch" href="/assets/js/55.b022076f.js"><link rel="prefetch" href="/assets/js/56.d648021f.js"><link rel="prefetch" href="/assets/js/57.daee90c0.js"><link rel="prefetch" href="/assets/js/58.1dc75068.js"><link rel="prefetch" href="/assets/js/59.8e0aa66f.js"><link rel="prefetch" href="/assets/js/6.a104c4e0.js"><link rel="prefetch" href="/assets/js/60.5971fa7d.js"><link rel="prefetch" href="/assets/js/61.b5d38972.js"><link rel="prefetch" href="/assets/js/62.479ee1ec.js"><link rel="prefetch" href="/assets/js/63.9288134c.js"><link rel="prefetch" href="/assets/js/64.fd1fa594.js"><link rel="prefetch" href="/assets/js/65.6d7c8876.js"><link rel="prefetch" href="/assets/js/66.12eb7c68.js"><link rel="prefetch" href="/assets/js/67.ec6b9968.js"><link rel="prefetch" href="/assets/js/68.40a7cbed.js"><link rel="prefetch" href="/assets/js/69.1f663e2c.js"><link rel="prefetch" href="/assets/js/7.661a7c8f.js"><link rel="prefetch" href="/assets/js/70.a4b59650.js"><link rel="prefetch" href="/assets/js/71.d0a17b3b.js"><link rel="prefetch" href="/assets/js/72.ce31e327.js"><link rel="prefetch" href="/assets/js/73.689c681b.js"><link rel="prefetch" href="/assets/js/74.c3ee0764.js"><link rel="prefetch" href="/assets/js/75.631b23c2.js"><link rel="prefetch" href="/assets/js/76.5639d6d8.js"><link rel="prefetch" href="/assets/js/77.535d056c.js"><link rel="prefetch" href="/assets/js/78.4a10c037.js"><link rel="prefetch" href="/assets/js/79.1c4b1b82.js"><link rel="prefetch" href="/assets/js/8.cbcbaa9c.js"><link rel="prefetch" href="/assets/js/80.378f84af.js"><link rel="prefetch" href="/assets/js/81.cd50c718.js"><link rel="prefetch" href="/assets/js/82.fa313785.js"><link rel="prefetch" href="/assets/js/83.5a791c98.js"><link rel="prefetch" href="/assets/js/84.9deb80df.js"><link rel="prefetch" href="/assets/js/85.995a3a07.js"><link rel="prefetch" href="/assets/js/86.364d88cb.js"><link rel="prefetch" href="/assets/js/87.20848abb.js"><link rel="prefetch" href="/assets/js/88.b816d218.js"><link rel="prefetch" href="/assets/js/89.6bf9b49e.js"><link rel="prefetch" href="/assets/js/90.9e0ab005.js"><link rel="prefetch" href="/assets/js/91.5e91a1b3.js"><link rel="prefetch" href="/assets/js/92.64c206ac.js"><link rel="prefetch" href="/assets/js/93.8af7b9b1.js"><link rel="prefetch" href="/assets/js/94.83bb9556.js"><link rel="prefetch" href="/assets/js/95.1690cd1a.js"><link rel="prefetch" href="/assets/js/96.66883dcc.js"><link rel="prefetch" href="/assets/js/97.59f65ae5.js"><link rel="prefetch" href="/assets/js/98.0bf9d181.js"><link rel="prefetch" href="/assets/js/99.0fdea2a2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9825735b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="一颗牙疼" class="logo"> <span class="site-name can-hide">一颗牙疼</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/01.Java/" class="nav-link router-link-active">
  笔记
</a></div><div class="nav-item"><a href="https://github.com/Atoothache/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/01.Java/" class="nav-link router-link-active">
  笔记
</a></div><div class="nav-item"><a href="https://github.com/Atoothache/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/01.Java/" aria-current="page" class="sidebar-link">Java基础</a></li><li><a href="/01.Java/IO.html" class="sidebar-link">IO</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/01.Java/OOM排查.html" class="active sidebar-link">OOM排查</a></li><li><a href="/01.Java/三种io模型实现Socket编程.html" class="sidebar-link">三种io模型实现Socket编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/01.Java/三种io模型实现Socket编程.html#三种io模型实现socket编程" class="sidebar-link">三种io模型实现Socket编程</a></li></ul></li><li><a href="/01.Java/信号驱动IO VS 异步IO.html" class="sidebar-link">信号驱动IO VS 异步IO</a></li><li><a href="/01.Java/反射.html" class="sidebar-link">反射</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/01.Java/异常处理.html" class="sidebar-link">异常处理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/01.Java/总结ArriyList与HashMap.html" class="sidebar-link">总结ArriyList与HashMap</a></li><li><a href="/01.Java/注解的本质.html" class="sidebar-link">注解的本质</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>脚本语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模板引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全认证</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>搜索引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Netty</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="oom排查"><a href="#oom排查" class="header-anchor">#</a> OOM排查</h1> <p><a href="https://www.cnblogs.com/c-xiaohai/p/12489336.html" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>1、使用dmesg命令查看系统日志</p> <p>dmesg |grep -E ‘kill|oom|out of memory’，可以查看操作系统启动后的系统日志，这里就是查看跟内存溢出相关联的系统日志。</p> <p>2、这时候，需要启动项目，使用ps命令查看进程</p> <p>ps -aux|grep java命令查看一下你的java进程，就可以找到你的java进程的进程id。</p> <p>3、接着使用top命令</p> <p>top命令显示的结果列表中，会看到%MEM这一列，这里可以看到你的进程可能对内存的使用率特别高。以查看正在运行的进程和系统负载信息，包括cpu负载、内存使用、各个进程所占系统资源等。</p> <p><img src="https://img2020.cnblogs.com/i-beta/785859/202003/785859-20200313211136187-1482421735.png" alt="img"></p> <p>4、使用jstat命令</p> <p>用jstat -gcutil 20886 1000 10命令，就是用jstat工具，对指定java进程（20886就是进程id，通过ps -aux | grep java命令就能找到），按照指定间隔，看一下统计信息，这里会每隔一段时间显示一下，包括新生代的两个S0、s1区、Eden区，以及老年代的内存使用率，还有young gc以及full gc的次数。</p> <p>使用 jstat -gcutil 8968 500 5 表示每500毫秒打印一次Java堆状况（各个区的容量、使用容量、gc时间等信息），打印5次</p> <p><img src="https://img2020.cnblogs.com/i-beta/785859/202003/785859-20200313211613688-1397851893.png" alt="img"></p> <p>例如：</p> <p>看到的东西类似下面那样：</p> <p>S0    S1   E      O     YGC FGC</p> <p>26.80  0.00  10.50  89.90  86   954</p> <p>其实如果大家了解原理，应该知道，一般来说大量的对象涌入内存，结果始终不能回收，会出现的情况就是，快速撑满年轻代，然后young gc几次，根本回收不了什么对象，导致survivor区根本放不下，然后大量对象涌入老年代。老年代很快也满了，然后就频繁full gc，但是也回收不掉。</p> <p>然后对象持续增加不就oom了，内存放不下了，爆了呗。</p> <p>所以jstat先看一下基本情况，马上就能看出来，其实就是大量对象没法回收，一直在内存里占据着，然后就差不多内存快爆了。</p> <p>5、使用jmap命令查看</p> <p>执行jmap -histo pid可以打印出当前堆中所有每个类的实例数量和内存占用，如下，class name是每个类的类名（[B是byte类型，[C是char类型，[I是int类型），bytes是这个类的所有示例占用内存大小，instances是这个类的实例数量。</p> <p><img src="https://img2020.cnblogs.com/i-beta/785859/202003/785859-20200313212243116-1782997004.png" alt="img"></p> <p><strong>6、把当前堆内存的快照转储到dumpfile_jmap.hprof文件中，然后可以对内存快照进行分析</strong></p> <p>使用jmap -dump:format=b,file=文件名 [pid]，就可以把指定java进程的堆内存快照搞到一个指定的文件里去，但是jmap -dump:format其实一般会比较慢一些，也可以用gcore工具来导出内存快照</p> <p>例如：jmap -dump:format=b,file=D:/log/jvm/dumpfile_jmap.hprof 20886</p> <p>接着就是可以用MAT工具，或者是Eclipse MAT的内存分析插件，来对hprof文件进行分析，看看到底是哪个王八蛋对象太多了，导致内存溢出了</p> <p><img src="https://img2020.cnblogs.com/i-beta/785859/202003/785859-20200313212822382-608791208.png" alt="img"></p> <p>或者使用jdk的目录下的bin目录下的：jvisualvm.exe</p> <p><img src="https://img2020.cnblogs.com/i-beta/785859/202003/785859-20200313212916888-1008682266.png" alt="img"></p> <p>8、总结：</p> <p>一般常见的OOM，要么是短时间内涌入大量的对象，导致你的系统根本支持不住，此时你可以考虑优化代码，或者是加机器；要么是长时间来看，你的很多对象不用了但是还被引用，就是内存泄露了，你也是优化代码就好了；这就会导致大量的对象不断进入老年代，然后频繁full gc之后始终没法回收，就撑爆了</p> <p>要么是加载的类过多，导致class在永久代理保存的过多，始终无法释放，就会撑爆</p> <p>我这里可以给大家最后提一点，人家肯定会问你有没有处理过线上的问题，你就说有，最简单的，你说有个小伙子用了本地缓存，就放map里，结果没控制map大小，可以无限扩容，最终导致内存爆了，后来解决方案就是用了一个ehcache框架，自动LRU清理掉旧数据，控制内存占用就好了。</p> <p>另外，务必提到，线上jvm必须配置-XX:+HeapDumpOnOutOfMemoryError，-XX:HeapDumpPath=/path/heap/dump。因为这样就是说OOM的时候自动导出一份内存快照，你就可以分析发生OOM时的内存快照了，到底是哪里出现的问题。</p> <p><strong>9、修改代码调优，修改jvm配置调优，部署接口压测</strong></p> <p>代码进行优化、根据压测的情况去进行一定的jvm参数的调优，一个系统的QPS，一个是系统的接口的性能，压测到一定程度的时候 ，机器的cpu、内存、io、磁盘的一些负载情况，jvm的表现</p> <p><strong>10、流程</strong></p> <p><img src="https://img2020.cnblogs.com/i-beta/785859/202003/785859-20200313222136093-1913146165.png" alt="img"></p> <p><strong>附加：系统频繁full gc</strong>：</p> <p>比OOM稍微好点的是频繁full gc，如果OOM就是系统自动就挂了，很惨，你绝对是超级大case，但是频繁full gc会好多，其实就是表现为经常请求系统的时候，很卡，一个请求卡半天没响应，就是会觉得系统性能很差。</p> <p>首先，你必须先加上一些jvm的参数，让线上系统定期打出来gc的日志：</p> <p>-XX:+PrintGCTimeStamps</p> <p>-XX:+PrintGCDeatils</p> <p>-Xloggc:<filename></filename></p> <p>这样如果发现线上系统经常卡顿，可以立即去查看gc日志，大概长成这样：</p> <p><img src="https://img2020.cnblogs.com/i-beta/785859/202003/785859-20200313213420718-1653747419.png" alt="img"></p> <p>如果要是发现每次Full GC过后，ParOldGen就是老年代老是下不去，那就是大量的内存一直占据着老年代，啥事儿不干，回收不掉，所以频繁的full gc，每次full gc肯定会导致一定的stop the world卡顿，这是不可能完全避免的</p> <p>接着采用跟之前一样的方法，就是dump出来一份内存快照，然后用Eclipse MAT插件分析一下好了，看看哪个对象量太大了</p> <p>接着其实就是跟具体的业务场景相关了，要看具体是怎么回事，常见的其实要么是内存泄露，要么就是类加载过多导致永久代快满了，此时一般就是针对代码逻辑来优化一下。</p> <p>给大家还是举个例子吧，我们线上系统的一个真实例子，大家可以用这个例子在面试里来说，比如说当时我们有个系统，在后台运行，每次都会一下子从mysql里加载几十万行数据进来各种处理，类似于定时批量处理，这个时候，如果对几十万数据的处理比较慢，就会导致比如几分钟里面，大量数据囤积在老年代，然后没法回收，就会频繁full gc。</p> <p>当时我们其实就是根据这个发现了当时两台机器已经不够了，因为我们当时线上用了两台4核8G的虚拟机在跑，明显不够了，就要加机器了，所以增加了机器，每台机器处理更少的数据量，那不就ok了，马上就缓解了频繁full gc的问题了。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/01.Java/IO.html" class="prev">
        IO
      </a></span> <span class="next"><a href="/01.Java/三种io模型实现Socket编程.html">
        三种io模型实现Socket编程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f1b473bd.js" defer></script><script src="/assets/js/2.fe0fd2e3.js" defer></script><script src="/assets/js/9.bbc07289.js" defer></script>
  </body>
</html>
